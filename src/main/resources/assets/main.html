<!DOCTYPE html>
<html ng-app="mainApp">
<head>
<meta charset="UTF-8">
<title>主页</title>
<link href="/ineuron/css/leftmenu.css" rel="stylesheet">
<!-- for DataTable -->
<link rel="stylesheet" href="/ineuron/css/bootstrap.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/font-awesome-animation/dist/font-awesome-animation.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables/media/css/jquery.dataTables.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-colreorder/css/dataTables.colReorder.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-colvis/css/dataTables.colVis.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-tabletools/css/dataTables.tableTools.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-responsive/css/responsive.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-scroller/css/dataTables.scroller.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-fixedcolumns/css/fixedColumns.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-fixedheader/css/fixedHeader.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-buttons/css/buttons.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-select/css/select.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/backtotop/backtotop.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/dist/css/angular-datatables.css">

<script src="/ineuron/js/jquery-2.1.1.min.js"></script>
<script src="/ineuron/js/jquery.dataTables.min.js"></script>
<script src="/ineuron/js/angular.min.js"></script>
<script src="/ineuron/js/angular-datatables.min.js"></script>
<script src="/ineuron/js/angular-resource.min.js"></script>

<script src="/ineuron/js/bootstrap-3.2.0.min.js"></script>
<script src="/ineuron/js/angular-ui-router.js"></script>
<script src="/ineuron/js/angular-cookies.min.js"></script>

<link rel="stylesheet" href="/ineuron/css/isteven-multi-select.css">
<link rel="stylesheet" href="/ineuron/css/bootstrap.min.css">
<script src="/ineuron/js/angular.min.js"></script>
<script src="/ineuron/js/isteven-multi-select.js"></script>


<script type="text/javascript">

		//define the package as userApp
		var mainApp = angular.module('mainApp', [ 'ui.router', 'ngCookies', 'datatables', 'isteven-multi-select']);
		
		mainApp.config(function($stateProvider) {
					
			var userManagementState = {
			    name: 'userManagement',
			    url: 'userManagement',
			    templateUrl: '/ineuron/user/list.html',
			    controller: 'UserListController'
			  }

			  var aboutState = {
			    name: 'about',
			    url: '/about',
			    template: '<h3>琥崧智能工厂运营与控制系统</h3>'
			  }
			
			 var updateUserState = {
				    name: 'updateUser',
				    url: 'updateUser/{username}',
				    views: {'':{				    	
				    	templateUrl: '/ineuron/user/updateUser.html',
					    controller: 'UserUpdateController'		    
				    	}
				    }				    
				  }

			  $stateProvider.state(userManagementState);
			  $stateProvider.state(updateUserState);
			  $stateProvider.state(aboutState);
			  
			});
		
		mainApp.controller('NavMenuController', function($scope){
			$scope.ShowUserManagementMenu=function(){
				return true;	
			}			
		});
		
		mainApp.controller('UserUpdateController',function($scope, $stateParams, $http, $state, $cookies){
			var username=$stateParams.username;
			$scope.updateUsername=$stateParams.username;
			
			var vm=this;
			
			//Get user by name
			$http({
	            url:'/user/user',
	            method: 'GET',
	            data: {'username':username}	            
	        }).success(function(userdata){
	        	validateApiToken(data, $cookies);
	        	$scope.user=userdata.value;	        	
	        }).error(function(userdata){
	        	alert('error: get user by name');
	            console.log("error:getuserbyname");
	        });
			
			
			//Get Rolelist
 			$http({
	            url:'/user/rolelist',
	            method: 'GET'      
	        }).success(function(roledata){
	        	validateApiToken(data, $cookies);
	        	vm.roles=roledata.value;
	        }).error(function(roledata){
	        	alert('error');
	            console.log("error:getrolelist");
	        });
			
	
			vm.updateUser = updateUser;
			
			function updateUser(){				
				var strRoles="";
				var usernewroles=$scope.newroles;
				for (var i in usernewroles){
					strRoles=strRoles.concat(usernewroles[i].rolename,"|");
				};
				strRoles=strRoles.substring(0,strRoles.length-1);
				
				alert(strRoles);				   

				$http({
		            url:'/user/update',
		            method: 'POST',
		            data: {username:$scope.updateUsername, role:$scope.updateRoleSelected}      
		        }).success(function(data){
		        	validateApiToken(data, $cookies);
		        	$state.go("userManagement");
		            
		        }).error(function(data){
		        	alert('error');
		            console.log("error");
		        })
			}
			
		});

		
		 mainApp.controller('UserListController', function($http, $scope, $location, $cookies, DTOptionsBuilder, DTColumnDefBuilder){
			var vm = this;
			$http({
				url:'/user/list',
	            method: 'GET'
			}).success(function(data) {	
				validateApiToken(data, $cookies);
				vm.users = data.value;					
			}).error(function(data){
	        	alert('error');
	            console.log("error");
	        });
					
			//Get Rolelist
 			$http({
	            url:'/user/rolelist',
	            method: 'GET'      
	        }).success(function(roledata){
	        	validateApiToken(data, $cookies);
	        	vm.roles=roledata.value;
	        }).error(function(roledata){
	        	alert('error');
	            console.log("error:getrolelist");
	        });
			
			//replace user.role id to name
			for (var i in vm.users){
				var roleList=vm.users[i].role.split("|");
				var strRoles="";
				for (var j in roleList){
				  for (var k in vm.roles){				  
					if (roleList[j]==vm.roles[k].id){ roleList[j]=vm.roles[k].rolename; break}
				 }
				  strRoles=strRoles.concat(roleList[j],"|");
				}
				strRoles=strRoles.substring(0,strRoles.length-1);
				vm.users[i].role=strRoles;
			 }					
				
				
			 vm.dtOptions = DTOptionsBuilder.newOptions().withPaginationType('full_numbers');
			    vm.dtColumnDefs = [
			        DTColumnDefBuilder.newColumnDef(0),
			        DTColumnDefBuilder.newColumnDef(1),
			        DTColumnDefBuilder.newColumnDef(2),
			        DTColumnDefBuilder.newColumnDef(3).notSortable(),
			        DTColumnDefBuilder.newColumnDef(4).notSortable()
			    ];
			    //vm.user2Add = _buildUser2Add(1);
			    vm.addUser = addUser;
			    vm.removeUser = removeUser;

			     function addUser(index) {
			        //vm.users.push(angular.copy(vm.person2Add));
			        //vm.person2Add = _buildPerson2Add(vm.person2Add.id + 1);
			        alert("add 1");
			        alert("add"+vm.users[index].username);
			    }
			    
   
			    function removeUser(index) {
			        alert("remove");
			        alert(vm.users[index].username);
			    } 
		 }
			 
		);
		
		
		function validateApiToken(data, cookies){
        	if(data.apiToken == null){
        		alert("会话已过期，请重新登录");
        		window.location.href="/ineuron/user/index.html/#/login";
        	}
        	cookies.put('INeuron-ApiToken', encodeURI(encodeURI(data.apiToken)), {path:"/"});  
		}
		
	</script>
</head>

<body>
	<div class="navbar navbar-duomi navbar-static-top" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
				<table width="300%" border="0">
					<tbody>
						<tr>
							<td><img alt="" src="/ineuron/images/logo.png"></td>

							<td align="center"><a class="navbar-brand">琥崧智能工厂运营与控制系统</a></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<div ng-controller="NavMenuController" class="container-fluid">
		<div class="row">
			<div class="col-md-2">
				<ul id="main-nav" class="nav nav-tabs nav-stacked" style="">
					<li class="active"><a href="#"> <i
							class="glyphicon glyphicon-th-large"></i> 首页
					</a></li>
					<li><a href="#systemSetting" class="nav-header collapsed"
						data-toggle="collapse"> <i class="glyphicon glyphicon-cog"></i>
							系统管理 <span class="pull-right glyphicon glyphicon-chevron-down"></span>
					</a>
						<ul id="systemSetting" class="nav nav-list collapse secondmenu"
							style="height: 0px;">
							<li><a ui-sref="userManagement" ng-show="ShowUserManagementMenu()" ui-sref-active="active"><i
									class="glyphicon glyphicon-user"></i>用户管理</a></li>
							<li><a href="#"><i class="glyphicon glyphicon-asterisk"></i>角色管理</a></li>
							<li><a href="#"><i class="glyphicon glyphicon-edit"></i>修改密码</a></li>
						</ul></li>
					<li><a href="./plans.html"><i
							class="glyphicon glyphicon-credit-card"></i> 产品管理 </a></li>
					<li><a href="#"><i class="glyphicon glyphicon-th-list"></i>
							订单管理 </a></li>
					<li><a href="#"><i class="glyphicon glyphicon-wrench"></i>
							生产管理 </a></li>
					<li><a ui-sref="about" ui-sref-active="active"> <i
							class="glyphicon glyphicon-fire"></i> 关于系统
					</a></li>
				</ul>
			</div>
			<div class="col-md-10">
				<ui-view></ui-view>
			</div>
		</div>
	</div>


</body>
</html>