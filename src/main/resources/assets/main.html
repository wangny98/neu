<!DOCTYPE html>
<html ng-app="mainApp">
<head>
<meta charset="UTF-8">
<title>主页</title>
<link href="/ineuron/css/leftmenu.css" rel="stylesheet">
<!-- for DataTable -->
<link rel="stylesheet" href="/ineuron/css/bootstrap.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/font-awesome-animation/dist/font-awesome-animation.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables/media/css/jquery.dataTables.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-colreorder/css/dataTables.colReorder.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-colvis/css/dataTables.colVis.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-tabletools/css/dataTables.tableTools.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-responsive/css/responsive.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-scroller/css/dataTables.scroller.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-fixedcolumns/css/fixedColumns.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-fixedheader/css/fixedHeader.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-buttons/css/buttons.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/datatables-select/css/select.dataTables.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/backtotop/backtotop.min.css">
<link rel="stylesheet"
	href="/ineuron/css/datatable-css/dist/css/angular-datatables.css">

<script src="/ineuron/js/jquery-2.1.1.min.js"></script>
<script src="/ineuron/js/jquery.dataTables.min.js"></script>
<script src="/ineuron/js/angular.min.js"></script>
<script src="/ineuron/js/angular-datatables.min.js"></script>
<script src="/ineuron/js/angular-resource.min.js"></script>

<script src="/ineuron/js/bootstrap-3.2.0.min.js"></script>
<script src="/ineuron/js/angular-ui-router.js"></script>
<script src="/ineuron/js/angular-cookies.min.js"></script>



<script type="text/javascript">

		//define the package as userApp
		var mainApp = angular.module('mainApp', [ 'ui.router', 'ngCookies', 'datatables']);
		
		mainApp.config(function($stateProvider) {
					
			var userManagementState = {
			    name: 'userManagement',
			    url: 'userManagement',
			    templateUrl: '/ineuron/user/list.html',
			    controller: 'UserListController'
			  }

			  var aboutState = {
			    name: 'about',
			    url: '/about',
			    template: '<h3>琥崧智能工厂运营与控制系统</h3>'
			  }
			
			 var updateUserState = {
				    name: 'updateUser',
				    url: 'updateUser/{username}',
				    views: {'':{
				    	
				    	templateUrl: '/ineuron/user/updateUser.html',
					    controller: 'UserUpdateController'
					    
				    	}
				    }
				    
				  }

			  $stateProvider.state(userManagementState);
			  $stateProvider.state(updateUserState);
			  $stateProvider.state(aboutState);
			});
		
		mainApp.controller('UserUpdateController',function($scope, $stateParams, $http, $state, $cookies){
			$scope.updateUsername=$stateParams.username;
			var vm = this;
			var roleData = [{
			    "id": 1,
			    "role": "admin"
			}, {
			    "id": 2,
			    "role": "salesperson"
			}, {
			    "id": 3,
			    "role": "production-person"
			}, {
			    "id": 4,
			    "role": "guest"
			}
			];
			
			vm.roles=roleData;
					
			vm.updateUser = updateUser;
			
			function updateUser(){
				var username = $cookies.get('INeuron-UserName');
				var apiToken = encodeURI(encodeURI($cookies.get('INeuron-ApiToken')));
				$http({
		            url:'/user/update',
		            method: 'POST',
		            headers: {'username':username, 'apiToken':apiToken},
		            data: {username:$scope.updateUsername, role:$scope.updateRoleSelected}      
		        }).success(function(data){
		        	validateApiToken(data, $cookies);
		        	$state.go("userManagement");
		            
		        }).error(function(data){
		        	alert('error');
		            console.log("error");
		        })
			}
			
		});

		
		 mainApp.controller('UserListController', function($http, $scope, $location, $cookies, DTOptionsBuilder, DTColumnDefBuilder){
			var vm = this;
			var username = $cookies.get('INeuron-UserName');
			var apiToken = encodeURI(encodeURI($cookies.get('INeuron-ApiToken')));
			$http({
				url:'/user/list',
	            method: 'GET',
	            headers: {'username':username, 'apiToken':apiToken}
			}).success(function(data) {	
				validateApiToken(data, $cookies);
				vm.users = data.value;					
			}).error(function(data){
	        	alert('error');
	            console.log("error");
	        })
					
			
			 vm.dtOptions = DTOptionsBuilder.newOptions().withPaginationType('full_numbers');
			    vm.dtColumnDefs = [
			        DTColumnDefBuilder.newColumnDef(0),
			        DTColumnDefBuilder.newColumnDef(1),
			        DTColumnDefBuilder.newColumnDef(2).notSortable(),
			        DTColumnDefBuilder.newColumnDef(3).notSortable()
			    ];
			    //vm.user2Add = _buildUser2Add(1);
			    vm.addUser = addUser;
			    vm.modifyUser = modifyUser;
			    vm.removeUser = removeUser;

			    function addUser(index) {
			        //vm.users.push(angular.copy(vm.person2Add));
			        //vm.person2Add = _buildPerson2Add(vm.person2Add.id + 1);
			        alert("add 1");
			        alert("add"+vm.users[index].username);
			    }
			    
			    function modifyUser(index) {
			       $scope.edit=true;
			       $scope.updateUsername=vm.users[index].username;
			       $location.path("updateUser");
			    }
			    
			    function removeUser(index) {
			        alert("remove");
			        alert(vm.users[index].username);
			    }
		 }
			 
		);
		
		
		function validateApiToken(data, cookies){
        	if(data.apiToken == null){
        		alert("会话已过期，请重新登录");
        		window.location.href="/ineuron/user/index.html/#/login";
        	}
        	cookies.put('INeuron-ApiToken', data.apiToken, {path:"/"});  
		}
		
	</script>
</head>

<body>
	<div class="navbar navbar-duomi navbar-static-top" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
			  <table width="300%" border="0">
		        <tbody>
			       <tr>
			         <td><img alt="" src="/ineuron/images/logo.png"></td>
                     
			         <td align="center"><a class="navbar-brand" >琥崧智能工厂运营与控制系统</a></td>
		           </tr>
	            </tbody>
		      </table>
		    </div>
		</div>
	</div>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-2">
				<ul id="main-nav" class="nav nav-tabs nav-stacked" style="">
					<li class="active"><a href="#"> <i
							class="glyphicon glyphicon-th-large"></i> 首页
					</a></li>
				 <li><a href="#systemSetting" class="nav-header collapsed"
						data-toggle="collapse"> <i class="glyphicon glyphicon-cog"></i>
							系统管理 <span class="pull-right glyphicon glyphicon-chevron-down"></span>
					</a>
						<ul id="systemSetting" class="nav nav-list collapse secondmenu"
							style="height: 0px;">
							<li><a ui-sref="userManagement" ui-sref-active="active"><i
									class="glyphicon glyphicon-user"></i>用户管理</a></li>
							<li><a href="#"><i class="glyphicon glyphicon-asterisk"></i>角色管理</a></li>
							<li><a href="#"><i class="glyphicon glyphicon-edit"></i>修改密码</a></li>
						</ul>
					</li>
					<li><a href="./plans.html"><i class="glyphicon glyphicon-credit-card"></i>
						产品管理 
						</a>
					</li>
					<li><a href="#"><i class="glyphicon glyphicon-th-list"></i>
						订单管理
						</a>
					</li>
					<li><a href="#"><i class="glyphicon glyphicon-wrench"></i>
						生产管理
						</a>
					</li>
					<li><a ui-sref="about" ui-sref-active="active"> 
					<i class="glyphicon glyphicon-fire"></i> 关于系统
					</a>
					</li>
				</ul>
			</div>
			<div class="col-md-10">
				<ui-view></ui-view>
			</div>
		</div>
	</div>


</body>
</html>